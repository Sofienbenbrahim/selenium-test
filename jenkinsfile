pipeline {
     agent any

     stages {
         stage('Checkout') {
             steps {
                 checkout scm
             }
         }

         stage('Install Dependencies') {
             steps {
                 script {
                     sh 'pip install selenium'
                     sh 'pip install behave'
                     sh 'pip install allure-behave'
                     sh 'pip install chromedriver'
                 }
             }
         }

         stage('Run Tests & Generate Allure Report') {
             steps {
                 script {
                     sh 'behave features/login.feature --format allure_behave.formatter:AllureFormatter -o allure-results'
                 }
             }
         }

         stage('Publish Reports') {
             steps {
                 script {
                     // Publish Allure reports
                     allure([includeProperties: false, jdk: '',
                              properties: [], reportBuildPolicy: 'ALWAYS',
                              results: [[path: 'allure-results']]])

                     // Optionally, archive the JSON report
                     //archiveArtifacts '/var/lib/jenkins/workspace/python-selenium/result.json'
                 }
             }
         }
    
     }
 post {
        always {
            // Generate Allure report as HTML string
            def allureReport = sh(script: 'allure generate allure-results -o allure-report --clean && cat allure-report/index.html', returnStdout: true).trim()

            // Send email notification with Allure report
            emailext body: "Your Jenkins pipeline has completed successfully.\n\n${allureReport}",
                     subject: 'Jenkins Pipeline Notification with Allure Report',
                     to: 'elyeslayes0@gmail.com',
                     mimeType: 'text/html'
        }
         }
}
